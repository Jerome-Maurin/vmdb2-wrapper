# Use like this : sudo vmdb2 cubietruck-plus_buster_armhf_vmdb2-0.13.2.yaml --output cubietruck-plus_buster_armhf.img --rootfs-tarball buster_armhf_rootfs.tgz --log=stderr
# Don't forget to flash the u-boot to the img file afterwards, this is not handled by vmdb2 in the 0.13.2 version (cf 0.14.1 file for hints, use kpartx -asv cubietruck-plus_buster_armhf.img & mount, to recover u-boot file)
steps:
  - mkimg: "{{ output }}"
    size: 3G

  - mklabel: msdos
    device: "{{ output }}"

  - mkpart: primary
    device: "{{ output }}"
    start: 0%
    end: 100%
    tag: root

  - kpartx: "{{ output }}"

  - mkfs: ext4
    partition: root

  - mount: root

  - unpack-rootfs: root

  - qemu-debootstrap: buster
    mirror: http://ftp.de.debian.org/debian
    target: root
    arch: armhf
    components:
    - main
    - contrib
    - non-free
    unless: rootfs_unpacked

  - apt: install
    packages:
      - linux-image-armmp-lpae
    tag: root
    unless: rootfs_unpacked

  - apt: install
    packages:
      - flash-kernel
    tag: root
    unless: rootfs_unpacked

  - cache-rootfs: root
    unless: rootfs_unpacked

  - chroot: root
    shell: |
      echo "/dev/mmcblk0p1 / ext4 noatime,nodiratime,errors=remount-ro 0 1" > /etc/fstab
      echo "CubietruckPlus" > /etc/hostname

      echo "Cubietech Cubietruck Plus" > /etc/flash-kernel/machine
      sed -i "s_quiet_root=/dev/mmcblk0p1 net.ifnames=0_g" /etc/default/flash-kernel
      update-initramfs -u
      rm /etc/flash-kernel/machine

      sed -i "s_root:\*:_root::_g" /etc/shadow

  - apt: install
    packages:
      - u-boot-sunxi
    tag: root 

  - chroot: root
    shell: |
      echo -e "auto lo\niface lo inet loopback" > /etc/network/interfaces.d/eth0
      echo -e "auto eth0\niface eth0 inet dhcp" > /etc/network/interfaces.d/eth0
      echo > /etc/resolv.conf
