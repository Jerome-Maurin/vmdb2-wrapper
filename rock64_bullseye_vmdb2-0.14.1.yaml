# Use like this : sudo vmdb2 rock64_bullseye_vmdb2-0.14.1.yaml --output rock64.img --rootfs-tarball bullseye_arm64_rootfs.tgz --log=stderr
steps:
  - mkimg: "{{ output }}"
    size: 2G

  - mklabel: msdos
    device: "{{ output }}"

  - mkpart: primary
    device: "{{ output }}"
    start: 0%
    end: 100%
    tag: root

  - kpartx: "{{ output }}"

  - mkfs: ext4
    partition: root

  - mount: root

  - unpack-rootfs: root

# We need bullseye because the u-boot-rockchip deb package from buster doesn't support the rock64
  - qemu-debootstrap: bullseye
    mirror: http://ftp.de.debian.org/debian
    target: root
    arch: arm64
    components:
    - main
    - contrib
    - non-free
    unless: rootfs_unpacked

  - fstab: root
    unless: rootfs_unpacked

  - chroot: root
    shell: |
      sed -i s_errors=remount-ro_noatime,nodiratime,errors=remount-ro_g /etc/fstab
    unless: rootfs_unpacked

  - apt: install
    packages:
      - linux-image-arm64
    tag: root
    unless: rootfs_unpacked

  - apt: install
    packages:
      - flash-kernel
    tag: root
    unless: rootfs_unpacked

  - cache-rootfs: root
    unless: rootfs_unpacked

  - create-file: /etc/hostname
    contents: |+
      CubietruckPlus

  - create-file: /etc/flash-kernel/machine
    contents: |+
      Pine64 Rock64

  - chroot: root
    shell: |
      sed -i "s_quiet_root=$(grep ^UUID /etc/fstab | cut -d \  -f 1) net.ifnames=0_g" /etc/default/flash-kernel
      flash-kernel
      rm /etc/flash-kernel/machine

      sed -i "s_root:\*:_root::_g" /etc/shadow

  - apt: install
    packages:
      - u-boot-rockchip
    tag: root 

  - root-fs: root
    shell: |
      dd conv=fsync,notrunc if=$ROOT/usr/lib/u-boot/rock64-rk3328/idbloader.img of="{{ output }}" seek=64
      dd conv=fsync,notrunc if=$ROOT/usr/lib/u-boot/rock64-rk3328/u-boot.img of="{{ output }}" seek=16384

  - create-file: /etc/network/interfaces.d/eth0
    contents: |+
      auto eth0
      iface eth0 inet dhcp

  - create-file: /etc/resolv.conf
    contents: |
